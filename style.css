import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDau2bGEVfZZIZtdEInGjTlQA7jSs0ndGU",
  authDomain: "a-christmas-gift.firebaseapp.com",
  databaseURL: "https://a-christmas-gift-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "a-christmas-gift",
  storageBucket: "a-christmas-gift.firebasestorage.app",
  messagingSenderId: "560215769128",
  appId: "1:560215769128:web:331327bdc0417b4056351d"
};

const firebaseApp = initializeApp(firebaseConfig);
const db = getDatabase(firebaseApp);

let unlocked = localStorage.getItem('wonderlandUnlocked') === 'true';
const lockScreen = document.getElementById('lockScreen');
const app = document.getElementById('app');

if (unlocked) {
  lockScreen.classList.add('hidden');
  app.classList.remove('hidden');
}

document.getElementById('unlockBtn').addEventListener('click', () => {
  const pw = document.getElementById('passwordInput').value.trim();
  if (pw.toUpperCase() === 'MOON') {
    localStorage.setItem('wonderlandUnlocked', 'true');
    lockScreen.classList.add('fade-out');
    setTimeout(() => {
      lockScreen.classList.add('hidden');
      app.classList.remove('hidden');
    }, 250);
  } else {
    alert('Incorrect secret word â¤ï¸');
  }
});

// ---------- NOTES ----------
const noteInput = document.getElementById('noteInput');
const saveNoteBtn = document.getElementById('saveNote');
const notesContainer = document.getElementById('notesContainer');
const notesRef = ref(db, 'notes');

saveNoteBtn.addEventListener('click', () => {
  const text = noteInput.value.trim();
  if (!text) return;
  push(notesRef, { text, time: Date.now() });
  noteInput.value = '';
});

onValue(notesRef, snapshot => {
  notesContainer.innerHTML = '';
  snapshot.forEach(child => {
    const div = document.createElement('div');
    div.className = 'note';
    div.textContent = child.val().text;
    notesContainer.appendChild(div);
  });
});

// ---------- BUCKET LIST ----------
const bucketInput = document.getElementById('bucketInput');
const addBucketBtn = document.getElementById('addBucketBtn');
const bucketList = document.getElementById('bucketList');
const bucketRef = ref(db, 'bucketList');

addBucketBtn.addEventListener('click', () => {
  const text = bucketInput.value.trim();
  if (!text) return;
  push(bucketRef, { text });
  bucketInput.value = '';
});

onValue(bucketRef, snapshot => {
  bucketList.innerHTML = '';
  snapshot.forEach(child => {
    const li = document.createElement('li');
    li.textContent = child.val().text;
    li.addEventListener('click', () => {
      li.classList.add('fade-out');
      setTimeout(() => { remove(ref(db, `bucketList/${child.key}`)); }, 250);
    });
    bucketList.appendChild(li);
  });
});

// ---------- MUSIC ----------
const musicInput = document.getElementById('songInput');
const addMusicBtn = document.getElementById('addSongBtn');
const musicList = document.getElementById('songsContainer');
const musicRef = ref(db, 'music');

addMusicBtn.addEventListener('click', () => {
  const link = musicInput.value.trim();
  if (!link) return;
  push(musicRef, { link });
  musicInput.value = '';
});

onValue(musicRef, snapshot => {
  musicList.innerHTML = '';
  snapshot.forEach(child => {
    const iframe = document.createElement('iframe');
    iframe.src = child.val().link;
    iframe.width = "100%"; iframe.height = "80";
    iframe.allow = "encrypted-media"; iframe.style.borderRadius = "12px";
    iframe.style.border = "none"; iframe.style.marginBottom = "10px";
    musicList.appendChild(iframe);
  });
});

// ---------- COUNTDOWN & ANIMATIONS ----------
const countdownEl = document.getElementById('countdown');
function updateCountdown() {
  const target = new Date("December 25, 2026 00:00:00").getTime();
  const gap = target - Date.now();
  if (gap <= 0) { countdownEl.textContent = 'Merry Christmas ðŸŽ„'; return; }
  const d = Math.floor(gap / 86400000), h = Math.floor((gap / 3600000) % 24), m = Math.floor((gap / 60000) % 60), s = Math.floor((gap / 1000) % 60);
  countdownEl.textContent = `${d}d : ${h}h : ${m}m : ${s}s`;
}
setInterval(updateCountdown, 1000);

const gift = document.getElementById('floatingGift');
let gx = 50, gy = 50, dx = 0.15, dy = 0.12;
setInterval(() => {
  gx += dx; gy += dy;
  if (gx < 0 || gx > 95) dx *= -1; if (gy < 0 || gy > 90) dy *= -1;
  gift.style.left = gx + '%'; gift.style.top = gy + '%';
}, 50);

setInterval(() => {
  const flake = document.createElement('div');
  flake.className = 'snowflake';
  flake.textContent = ['â„','âœ¨','ðŸ¤'][Math.floor(Math.random()*3)];
  flake.style.left = Math.random()*100 + 'vw';
  flake.style.fontSize = 10 + Math.random()*15 + 'px';
  flake.style.opacity = Math.random();
  flake.style.animationDuration = 5 + Math.random()*5 + 's';
  document.body.appendChild(flake);
  setTimeout(() => flake.remove(), 10000);
}, 300);
